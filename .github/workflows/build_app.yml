name: ğŸš€ è·¨å¹³å°åº”ç”¨æ„å»º (å¯é€‰æ‰‹æŒ/æ ‡ç­¾)

on:
  # å…è®¸åœ¨ GitHub Actions UI ä¸­æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      platform:
        description: 'é€‰æ‹©ç¼–è¯‘ç›®æ ‡å¹³å°'
        required: true
        type: choice
        default: macos
        options:
          - macos
          - windows
          - linux
      git_tag:
        description: 'Git æ ‡ç­¾æˆ–åˆ†æ”¯ (ä¾‹å¦‚: dev_v1.11.2)'
        required: true
        default: dev_v1.11.2 # ä½¿ç”¨æ‚¨å½“å‰æ‰€åœ¨çš„æ ‡ç­¾ä½œä¸ºé»˜è®¤å€¼
        type: string

jobs:
  build:
    # æ ¹æ®ç”¨æˆ·è¾“å…¥ platform æ¥é€‰æ‹©åˆé€‚çš„è¿è¡Œç¯å¢ƒ (runner)
    runs-on: ${{ inputs.platform == 'windows' && 'windows-latest' || inputs.platform == 'macos' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - name: 1. æ£€å‡º Fork ä»“åº“çš„é»˜è®¤åˆ†æ”¯
        # å…ˆæ£€å‡ºé»˜è®¤åˆ†æ”¯ï¼Œä»¥ä¾¿åç»­è¿›è¡Œ Git æ“ä½œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç¡®ä¿æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…æµ…å…‹éš†é™åˆ¶

      - name: 2. ä»ä¸Šæ¸¸ä»“åº“åŒæ­¥å¹¶åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾
        run: |
          # å®šä¹‰åŸä»“åº“çš„ URL
          UPSTREAM_URL="https://github.com/xiaoyaocz/dart_simple_live"
          TAG_REF="${{ github.event.inputs.git_tag }}"
          
          echo "å°è¯•åŒæ­¥ä¸Šæ¸¸æ ‡ç­¾å¹¶åˆ‡æ¢åˆ°ï¼š$TAG_REF"
          
          # 1. æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“ï¼ˆåä¸º upstreamï¼‰
          git remote add upstream $UPSTREAM_URL
          
          # 2. ä»ä¸Šæ¸¸æ‹‰å–æŒ‡å®šçš„æ ‡ç­¾ï¼Œå¦‚æœæ‹‰å–å¤±è´¥ï¼Œåˆ™æŠ¥é”™å¹¶åœæ­¢å·¥ä½œæµ
          git fetch upstream refs/tags/$TAG_REF:refs/tags/$TAG_REF || { echo "::error title=Tag Missing::æ— æ³•ä»ä¸Šæ¸¸ä»“åº“æ‹‰å–æ ‡ç­¾ $TAG_REFã€‚è¯·æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨ã€‚"; exit 1; }
          
          # 3. åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾ï¼ˆç°åœ¨è¯¥æ ‡ç­¾å·²å­˜åœ¨äº runner çš„æœ¬åœ°ä»“åº“ä¸­ï¼‰
          git checkout $TAG_REF
          
          echo "æˆåŠŸåˆ‡æ¢åˆ°æ ‡ç­¾ $TAG_REFã€‚"

      - name: 3. è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.x' 
          channel: 'stable'

      - name: 4. è·å–ä¾èµ– (flutter pub get)
        # å‡è®¾ Flutter é¡¹ç›®ä½äº simple_live_app å­ç›®å½•
        run: flutter pub get
        working-directory: ./simple_live_app 

      - name: 5. ç¼–è¯‘ macOS Release ç‰ˆæœ¬
        if: ${{ inputs.platform == 'macos' }}
        run: flutter build macos --release
        working-directory: ./simple_live_app
      
      - name: 5. ç¼–è¯‘ Windows Release ç‰ˆæœ¬
        if: ${{ inputs.platform == 'windows' }}
        run: flutter build windows --release
        working-directory: ./simple_live_app

      - name: 5. ç¼–è¯‘ Linux Release ç‰ˆæœ¬
        if: ${{ inputs.platform == 'linux' }}
        run: flutter build linux --release
        working-directory: ./simple_live_app

      - name: 6. ç¡®å®šæ„å»ºäº§ç‰©è·¯å¾„
        id: build_path
        run: |
          BUILD_DIR=""
          # æ ¹æ®å¹³å°è®¾ç½®æ„å»ºè·¯å¾„ï¼Œç”¨äº artifacts ä¸Šä¼ 
          case ${{ inputs.platform }} in
            macos) BUILD_DIR="./simple_live_app/build/macos/Build/Products/Release/";;
            windows) BUILD_DIR="./simple_live_app/build/windows/runner/Release/";;
            linux) BUILD_DIR="./simple_live_app/build/linux/x64/release/bundle/";;
          esac
          echo "artifact_path=$BUILD_DIR" >> $GITHUB_OUTPUT # è®¾ç½®è¾“å‡ºå˜é‡

      - name: 7. ä¸Šä¼ æ„å»ºäº§ç‰© (Artifact)
        uses: actions/upload-artifact@v4
        with:
          # Artifact åç§°ï¼šmacOS-dev_v1.11.2
          name: ${{ inputs.platform }}-${{ github.event.inputs.git_tag }}
          path: ${{ steps.build_path.outputs.artifact_path }}
          retention-days: 7 # ä¿ç•™ 7 å¤©
